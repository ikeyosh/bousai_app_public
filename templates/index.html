{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
  <!-- é¿é›£æ‰€ãƒãƒƒãƒ— -->
  <div class="map-card">
    <div class="map-title">
      <i class="fas fa-map-marker-alt"></i>
      é¿é›£æ‰€ãƒãƒƒãƒ—
    </div>
    <div class="map-container">
      <div id="shelterMap"></div>
      <div class="map-legend">
        <div class="legend-item">
          <div class="legend-marker current"></div>
          <span>ç¾åœ¨åœ°</span>
        </div>
        <div class="legend-item">
          <div class="legend-marker shelter"></div>
          <span>é¿é›£æ‰€</span>
        </div>
      </div>
    </div>
  </div>

  <!-- æ°—è±¡è­¦å ±ãƒ»æ³¨æ„å ± -->
  <div class="weather-warning-card">
    <div class="weather-title">
      <div>
        <i class="fas fa-cloud-sun"></i>
        è—¤æ²¢å¸‚ æ°—è±¡è­¦å ±ãƒ»æ³¨æ„å ±
      </div>
      <div class="auto-update-indicator">
        <i class="fas fa-sync-alt" id="updateIcon"></i>
        <span>10åˆ†ãŠãè‡ªå‹•æ›´æ–°</span>
      </div>
    </div>
    <div id="weatherContent">
      {% if weather_warnings %}
        <div class="weather-info">
          <div class="weather-info-header">
            <i class="fas fa-map-marker-alt"></i>
            <span>{{ weather_warnings.area_name }}</span>
          </div>
          {% if weather_warnings.warnings %}
            <div class="weather-warnings-list">
              {% for warning in weather_warnings.warnings %}
                <div class="warning-item">
                  {% if 'ç‰¹åˆ¥è­¦å ±' in warning.name %}
                    <div class="warning-badge emergency">
                      <i class="fas fa-exclamation-triangle"></i>
                      {{ warning.name }}
                    </div>
                  {% elif 'è­¦å ±' in warning.name %}
                    <div class="warning-badge warning">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ warning.name }}
                    </div>
                  {% else %}
                    <div class="warning-badge advisory">
                      <i class="fas fa-info-circle"></i>
                      {{ warning.name }}
                    </div>
                  {% endif %}
                  <div class="warning-status">
                    {% if warning.status == 'ç™ºè¡¨' %}
                      ğŸ†• æ–°è¦ç™ºè¡¨
                    {% else %}
                      ğŸ”„ ç¶™ç¶šä¸­
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="no-warnings">
              <i class="fas fa-check-circle"></i>
              ç¾åœ¨ã€è­¦å ±ãƒ»æ³¨æ„å ±ã¯ç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã›ã‚“
            </div>
          {% endif %}
          <div class="weather-info-footer">
            <div class="update-time-item">
              <i class="far fa-clock"></i>
              <span>æœ€çµ‚ç¢ºèª: <span id="lastFetchTime">{{ weather_warnings.last_fetch_time if weather_warnings.last_fetch_time else 'èª­ã¿è¾¼ã¿ä¸­...' }}</span></span>
            </div>
            <div class="update-time-item">
              <i class="fas fa-satellite-dish"></i>
              <span>æ°—è±¡åºæœ€çµ‚ç™ºè¡¨: {{ weather_warnings.report_time }}</span>
            </div>
          </div>
        </div>
      {% else %}
        <div class="weather-error">
          <i class="fas fa-exclamation-triangle"></i>
          æ°—è±¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Leaflet ã®èª­ã¿è¾¼ã¿ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
.dashboard-container {
  max-width: 800px;
  margin: 40px auto;
  padding: 20px;
}

.map-card {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(74,144,226,0.10);
  padding: 24px;
  margin-bottom: 32px;
}

.map-title {
  font-size: 1.3em;
  font-weight: 600;
  color: #2952a3;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.map-title i {
  font-size: 1.1em;
}

/* æ°—è±¡è­¦å ±ãƒ»æ³¨æ„å ±ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.weather-warning-card {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(74,144,226,0.10);
  padding: 24px;
  margin-bottom: 32px;
}

.weather-title {
  font-size: 1.3em;
  font-weight: 600;
  color: #2952a3;
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}

.weather-title > div:first-child {
  display: flex;
  align-items: center;
  gap: 8px;
}

.auto-update-indicator {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75em;
  color: #28a745;
  font-weight: 500;
}

.auto-update-indicator #updateIcon {
  animation: none;
}

.auto-update-indicator #updateIcon.rotating {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.weather-title i {
  font-size: 1.1em;
}

.weather-info {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
}

.weather-info-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: #495057;
  margin-bottom: 12px;
}

.weather-warnings-list {
  margin-bottom: 16px;
}

.warning-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding: 8px 0;
  border-bottom: 1px solid #e9ecef;
}

.warning-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.warning-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 0.9em;
}

.warning-badge.emergency {
  background: #dc3545;
  color: white;
}

.warning-badge.warning {
  background: #fd7e14;
  color: white;
}

.warning-badge.advisory {
  background: #ffc107;
  color: #212529;
}

.warning-status {
  font-size: 0.85em;
  color: #6c757d;
}

.no-warnings {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #28a745;
  font-weight: 600;
  margin-bottom: 16px;
}

.weather-error {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #dc3545;
  font-weight: 600;
  padding: 16px;
  background: #f8d7da;
  border-radius: 8px;
}

.weather-info-footer {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 0.85em;
  color: #6c757d;
  margin-top: 12px;
}

.update-time-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.map-container {
  position: relative;
}

#shelterMap {
  height: 300px;
  width: 100%;
  border-radius: 10px;
  border: 1px solid #e0e6ed;
}

.map-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 12px;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.9em;
  color: #666;
}

.legend-marker {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.legend-marker.current {
  background: #4a90e2;
}

.legend-marker.shelter {
  background: #ff6b35;
}

@media (max-width: 600px) {
  .dashboard-container {
    padding: 10px;
    margin: 20px auto;
  }

  .map-card, .weather-warning-card {
    padding: 20px 16px;
    margin-bottom: 20px;
  }

  .map-title, .weather-title {
    font-size: 1.2em;
  }

  #shelterMap {
    height: 250px;
  }

  .map-legend {
    flex-direction: column;
    gap: 10px;
    align-items: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæ±äº¬éƒ½åºå‘¨è¾ºã‚’ä¸­å¿ƒã«è¨­å®šï¼‰
    const map = L.map('shelterMap').setView([35.6895, 139.6917], 11);
    
    // OpenStreetMapã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    let allMarkers = [];
    
    // é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—ï¼ˆå…¨ã¦ã®é¿é›£æ‰€ã‚’å–å¾—ï¼‰
    fetch('/shelters')
        .then(response => {
            if (!response.ok) {
                throw new Error('é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            return response.json();
        })
        .then(shelters => {
            console.log('å–å¾—ã—ãŸé¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿:', shelters);
            
            // é¿é›£æ‰€ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            shelters.forEach(shelter => {
                // ç·¯åº¦çµŒåº¦ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
                if (shelter.lat && shelter.lon) {
                    const marker = L.circleMarker([shelter.lat, shelter.lon], {
                        radius: 8,
                        fillColor: '#ff6b35',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’ä½œæˆ
                    const popupContent = `
                        <div style="font-size: 14px; line-height: 1.4; min-width: 200px;">
                            <strong>${shelter.name}</strong><br>
                            <span style="color: #666;">ğŸ“ ${shelter.pref} ${shelter.city}</span><br>
                            ${shelter.address ? `<span style="color: #666;">ğŸ  ${shelter.address}</span><br>` : ''}
                            ${shelter.capacity && shelter.capacity > 0 ? `<br>åå®¹äººæ•°: ${shelter.capacity}äºº` : ''}
                            ${shelter.phone ? `<br>ğŸ“ ${shelter.phone}` : ''}
                            ${shelter.facilities ? `<br>è¨­å‚™: ${shelter.facilities}` : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                    allMarkers.push(marker);
                } else {
                    console.log('åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒãªã„é¿é›£æ‰€:', shelter.name);
                }
            });
            
            // å…¨ã¦ã®é¿é›£æ‰€ãƒãƒ¼ã‚«ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ç¯„å›²ã«åœ°å›³ã‚’èª¿æ•´
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
                console.log(`${allMarkers.length}å€‹ã®é¿é›£æ‰€ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
            } else {
                console.log('è¡¨ç¤ºå¯èƒ½ãªé¿é›£æ‰€ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            }
        })
        .catch(error => {
            console.error('é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ±äº¬å‘¨è¾ºã‚’è¡¨ç¤º
            map.setView([35.6895, 139.6917], 11);
        });
    
    // ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const currentLat = position.coords.latitude;
            const currentLon = position.coords.longitude;
            
            const currentLocationMarker = L.circleMarker([currentLat, currentLon], {
                radius: 10,
                fillColor: '#4a90e2',
                color: '#fff',
                weight: 3,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map);
            
            currentLocationMarker.bindPopup('ğŸ“ ç¾åœ¨åœ°');
            
            console.log('ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ:', currentLat, currentLon);
        }, function(error) {
            console.log('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
        });
    }

    // æ°—è±¡è­¦å ±ãƒ»æ³¨æ„å ±ã®è‡ªå‹•æ›´æ–°æ©Ÿèƒ½
    function updateWeatherWarnings() {
        const updateIcon = document.getElementById('updateIcon');
        const lastFetchTimeElement = document.getElementById('lastFetchTime');
        
        // æ›´æ–°ã‚¢ã‚¤ã‚³ãƒ³ã‚’å›è»¢ã•ã›ã‚‹
        updateIcon.classList.add('rotating');
        
        fetch('/api/weather_warnings')
            .then(response => response.json())
            .then(data => {
                console.log('æ°—è±¡æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', data);
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
                updateWeatherContent(data);
                
                // å–å¾—æ™‚åˆ»ã‚’æ›´æ–°
                if (lastFetchTimeElement) {
                    lastFetchTimeElement.textContent = data.last_fetch_time || 'æ›´æ–°å¤±æ•—';
                }
            })
            .catch(error => {
                console.error('æ°—è±¡æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                if (lastFetchTimeElement) {
                    lastFetchTimeElement.textContent = 'æ›´æ–°å¤±æ•—';
                }
            })
            .finally(() => {
                // æ›´æ–°ã‚¢ã‚¤ã‚³ãƒ³ã®å›è»¢ã‚’åœæ­¢
                setTimeout(() => {
                    updateIcon.classList.remove('rotating');
                }, 1000);
            });
    }

    function updateWeatherContent(data) {
        const weatherContent = document.getElementById('weatherContent');
        
        if (data.error) {
            weatherContent.innerHTML = `
                <div class="weather-error">
                    <i class="fas fa-exclamation-triangle"></i>
                    æ°—è±¡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
                </div>
            `;
            return;
        }

        let warningsHtml = '';
        
        if (data.warnings && data.warnings.length > 0) {
            warningsHtml = '<div class="weather-warnings-list">';
            data.warnings.forEach(warning => {
                let badgeClass = 'advisory';
                let icon = 'fas fa-info-circle';
                
                if (warning.name.includes('ç‰¹åˆ¥è­¦å ±')) {
                    badgeClass = 'emergency';
                    icon = 'fas fa-exclamation-triangle';
                } else if (warning.name.includes('è­¦å ±')) {
                    badgeClass = 'warning';
                    icon = 'fas fa-exclamation-circle';
                }

                const statusText = warning.status === 'ç™ºè¡¨' ? 'ğŸ†• æ–°è¦ç™ºè¡¨' : 'ğŸ”„ ç¶™ç¶šä¸­';

                warningsHtml += `
                    <div class="warning-item">
                        <div class="warning-badge ${badgeClass}">
                            <i class="${icon}"></i>
                            ${warning.name}
                        </div>
                        <div class="warning-status">${statusText}</div>
                    </div>
                `;
            });
            warningsHtml += '</div>';
        } else {
            warningsHtml = `
                <div class="no-warnings">
                    <i class="fas fa-check-circle"></i>
                    ç¾åœ¨ã€è­¦å ±ãƒ»æ³¨æ„å ±ã¯ç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã›ã‚“
                </div>
            `;
        }

        weatherContent.innerHTML = `
            <div class="weather-info">
                <div class="weather-info-header">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${data.area_name || 'è—¤æ²¢å¸‚'}</span>
                </div>
                ${warningsHtml}
                <div class="weather-info-footer">
                    <div class="update-time-item">
                        <i class="far fa-clock"></i>
                        <span>ãƒ‡ãƒ¼ã‚¿å–å¾—: <span id="lastFetchTime">${data.last_fetch_time || 'æ›´æ–°ä¸­...'}</span></span>
                    </div>
                    <div class="update-time-item">
                        <i class="fas fa-satellite-dish"></i>
                        <span>æ°—è±¡åºç™ºè¡¨: ${data.report_time || 'ä¸æ˜'}</span>
                    </div>
                </div>
            </div>
        `;
    }

    // 10åˆ†ï¼ˆ600,000ãƒŸãƒªç§’ï¼‰ãŠãã«è‡ªå‹•æ›´æ–°
    setInterval(updateWeatherWarnings, 600000);
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã€5ç§’å¾Œã«åˆå›æ›´æ–°ï¼ˆåˆæœŸãƒ‡ãƒ¼ã‚¿ãŒå¤ã„å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
    setTimeout(updateWeatherWarnings, 5000);
});
</script>
{% endblock %}
